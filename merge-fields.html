<form rhinoforms="true">
	<header>
		<h1>Interactive Merge</h1>
		<h2>Template Requested: <span class="tName">{{template/fileName}}</span></h2>
	</header>
	<section id="destinations">
		<h2>Available destinations: </h2>
		<ul>
			<rf.forEach select="destinations/destination" as="d">
				<li>
					<input type="checkbox" name="selectedDestinations.{{d.@name}}" value="true"><label>{{d.@name}}</label>
				</li>
			</rf.forEach>
		</ul>
	</section>
	<section id="fields">
		<rf.forEach select="data/record/field/*" as="f">
			<div class="mergeField" id="fw_{{f.name()}}">
				<input type="hidden" name="data.record.field.{{f.name()}}" 
					   rf.validationFunction="validateMergeField(this, '{{f.parent::field.@mandatory}}', '{{f.parent::field.@type}}')"/>
			</div>
			<script>
				interactive_merge.createControl($("#fw_{{f.name()}}"),{
					name: 'data.record.field.{{f.name()}}.im',
					label: '{{f.parent::field.@label}}',
					type: '{{f.parent::field.@type}}',
					mandatory: '{{f.parent::field.@mandatory}}',
					value: '{{f}}'
				});
			</script>
		</rf.forEach>
	</section>
	<input type="button" value="Next" class="im-submit"/>
	<input type="submit" rf.action="next" value="Next" style="display:none">
	<script>
		rf.onFormLoad(function(){
			
			$.get('rhinoforms/data-document/{{rf.flowId}}', function(data){
				merge_preview.showPayloadData(data.childNodes[0].getElementsByTagName('mmJob')[0]);
			})
			
			// initialise CKEditor RTE for each IM textarea field
			interactive_merge.loadRTEs();

			// update rich text field rf counterparts before submitting
			$('input[type="button"].im-submit').click(function(){
				interactive_merge.updateRTEFields();
				$('input[rf\\.action=next]').click();
			});
		})
	</script>
</form>