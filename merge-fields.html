<form rhinoforms="true">
	<header>
		<h1>Interactive Merge - <span class="subName">{{/merge//jobDetails//description}}</span></h1>
		<h2>Template Requested: <span class="subName">{{template/fileName}}</span></h2>
	</header>
	<section id="destinations">
		<h2>Available destinations: </h2>
		<ul>
			<rf.forEach select="destinations/destination" as="d">
				<li>
					<input type="checkbox" name="selectedDestinations.{{d.@name}}" value="true"><label>{{d.@name}}</label>
				</li>
			</rf.forEach>
		</ul>
		<div class="searchTerms">
			<label for="input_searchTerms">Search Terms: </label>
			<input type="text" name="searchTerms" id="input_searchTerms"/>
		</div>
	</section>
	<section id="fields">
		<rf.forEach select="data/record/field/*" as="f">
			<div class="mergeField" id="fw_{{f.name()}}">
				<input type="hidden" name="data.record.field.{{f.name()}}" 
					   rf.validationFunction="validateMergeField(this, '{{f.parent::field.@mandatory}}', '{{f.parent::field.@type}}')"/>
			</div>
			<script>
				interactive_merge.createControl($("#fw_{{f.name()}}"),{
					name: 'data.record.field.{{f.name()}}.im',
					label: '{{f.parent::field.@label}}',
					type: '{{f.parent::field.@type}}',
					mandatory: '{{f.parent::field.@mandatory}}',
					value: '{{f}}'
				});
			</script>
		</rf.forEach>
	</section>
	<section id="submission">
		<div id="actions">
			<input type="button" value="Cancel" class="im-submit"/>
			<input type="button" value="Preview" class="im-submit"/>
			<input type="button" value="Submit" class="im-submit"/>
			<input type="submit" rf.action="reload" value="Next" style="display:none">
			<input type="submit" rf.action="submit" value="Next" style="display:none">
		</div>
	</section>
	<script>
		rf.onFormLoad(function(){
			
			$.get('rhinoforms/data-document/{{rf.flowId}}', function(data){
				merge_preview.showPayloadData(data.childNodes[0].getElementsByTagName('mmJob')[0]);
			})
			
			// initialise CKEditor RTE for each IM textarea field
			interactive_merge.loadRTEs();

			// update rich text field rf counterparts before submitting
			$('input[type="button"].im-submit').click(function(){
				interactive_merge.updateRTEFields();
				merge_preview.close();
				if ($(this).val() == 'Submit'){
					$('input[rf\\.action=submit]').click();
				} else {
					$('input[rf\\.action=reload]').click();
				}
				
			});
		})
	</script>
</form>